<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta property="og:url" content="https://arstechnica.com/information-technology/2019/11/solved-why-in-the-wild-bluekeep-exploits-are-causing-patched-machines-to-crash/"/>
    <meta property="og:site_name" content="Ars Technica"/>
    <meta property="article:published_time" content="2019-11-11T18:25:25+00:00"/>
    <meta property="og:title" content="Solved: Why in-the-wild Bluekeep exploits are causing patched machines to crash"/>
    <meta property="og:description" content="Metasploit module is being rewritten to fix incompatibility with 2018 Meltdown fixes."/>
  </head>
  <body>
    <article>
      <h1>Solved: Why in-the-wild Bluekeep exploits are causing patched machines to crash</h1>
      <h2>Metasploit module is being rewritten to fix incompatibility with 2018 Meltdown fixes.</h2>
      <address><time datetime="2019-11-11T18:25:25+00:00">11 Nov 2019, 18:25</time> by <a rel="author">Dan Goodin</a></address>
      <p>Recent in-the-wild attacks on the <a href="https://arstechnica.com/information-technology/2019/05/microsoft-warns-wormable-windows-bug-could-lead-to-another-wannacry/">critical Bluekeep vulnerability in many versions of Windows</a> aren’t just affecting unpatched machines. It turns out the exploits—which repurpose the <a href="https://arstechnica.com/information-technology/2019/09/exploit-for-wormable-bluekeep-windows-bug-released-into-the-wild/">September release from the Metasploit framework</a>—are also causing many patched machines to crash.</p>
      <p>Late last week, Windows users learned why: a <a href="https://msrc-blog.microsoft.com/2018/03/23/kva-shadow-mitigating-meltdown-on-windows/">separate patch Microsoft released 20 months ago</a> for the <a href="https://arstechnica.com/gadgets/2018/01/meltdown-and-spectre-every-modern-processor-has-unfixable-security-flaws/">Meltdown vulnerability in Intel CPUs</a>. Word of the crashes first emerged five days ago, when researcher Kevin Beaumont discovered a malicious, in-the-wild Bluekeep exploit <a href="https://twitter.com/GossiTheDog/status/1191642063315623937">caused one of his honeypots to crash four times overnight</a>. Metasploit developer Sean Dillon initially blamed the crashes on “mystical reptilian forces that control everything.” Then he read a <a href="https://twitter.com/sleepya_/status/1191239163959373824">Twitter post</a> from researcher Worawit Wang:</p>
      <figure>
        <iframe data-src="https://twitter.com/sleepya_/status/1191239163959373824?ref_src=twsrc%5Etfw" data-embed-type="twitter-tweet" width="100%" height="0" data-service="Twitter" scrolling="no" nowide=""/>
      </figure>
      <p>In a <a href="https://zerosum0x0.blogspot.com/2019/11/fixing-remote-windows-kernel-payloads-meltdown.html">post published on Thursday</a>, Dillon wrote:</p>
      <blockquote>Turns out my BlueKeep development labs didn't have the Meltdown patch, yet out in the wild it's probably the most common case. <br/><br/>tl;dr: Side effects of the Meltdown patch inadvertently breaks the syscall hooking kernel payloads used in exploits such as EternalBlue and BlueKeep. Here is a horribly hacky way to get around it... but: it pops system shells so you can run Mimikatz, and after all isn't that what it's all about?</blockquote>
      <h3>Recursive loop</h3>
      <p>Dillon’s post offers a deep-dive explanation for why his exploit didn’t work on machines that installed the Meltdown patch, which Microsoft called KVA Shadow, short for Kernel Virtual Address Shadow. In short, the mitigation worked by isolating virtual memory page tables of user-mode threads from kernel memory. The exception is a small subset of kernel code and structures, which must be exposed enough to swap kernel page tables when carrying out trap exceptions, syscalls, and similar functions. The shellcode spawned by Dillon’s Bluekeep exploit wasn’t part of the KVA Shadow code, so user mode couldn’t react with the Shadow Code. As a result, the kernel got stuck in a recursive loop until the system finally crashed.</p>
      <p>Dillon has since <a href="https://github.com/rapid7/metasploit-framework/pull/12553">rewritten the exploit code</a>. He expects the fix to be integrated into the official Metasploit Bluekeep module soon.</p>
      <p>The crashes came to light after attackers started exploiting Bluekeep in an attempt to install cryptocurrency miners on unpatched machines. The exploits don’t spread from computer to computer with no user interaction, and as noted, they also caused many machines to crash, causing many people to discount the potential severity of the Bluekeep vulnerability. Microsoft researchers, however, <a href="https://www.microsoft.com/security/blog/2019/11/07/the-new-cve-2019-0708-rdp-exploit-attacks-explained/">warned last week</a> that they “cannot discount enhancements that will likely result in more effective attacks.” They also said that “the BlueKeep exploit will likely be used to deliver payloads more impactful and damaging than coin miners.”</p>
      <p>Meanwhile, Marcus Hutchins, the security researcher who also goes by the handle MalwareTech, <a href="https://twitter.com/MalwareTechBlog/status/1192926816370970625">made a compelling case </a>that Bluekeep exploits have the potential to be severe even if they don’t spread as a worm from computer to computer without user interaction in the way the <a href="https://arstechnica.com/information-technology/2017/05/an-nsa-derived-ransomware-worm-is-shutting-down-computers-worldwide/">WannaCry</a> and <a href="https://arstechnica.com/information-technology/2017/06/petya-outbreak-was-a-chaos-sowing-wiper-not-profit-seeking-ransomware/">NotPetya</a> outbreaks did.</p>
      <h3>Internal pivot</h3>
      <p>WannaCry and NotPetya exploited the server message block protocol, which was enabled in many desktop computers. Bluekeep, by contrast, exploits Windows’ Remote Desktop Services, which is usually turned on only on servers.</p>
      <p>“A worm would not only attract a lot of attention, but be technically challenging due to the limitations of BlueKeep,” Hutchins <a href="https://twitter.com/MalwareTechBlog/status/1192926820506554368">wrote</a>. That hardly means Bluekeep doesn’t have the potential to do significant damage. Because servers typically act as domain administrators, network management tools, or share the same local administrator credentials with other network machines, they have the ability to control much of the network.</p>
      <p>“By compromising a network server, it is almost always extremely easy to use automated tooling to pivot internally (Ex: have the server drop ransomware to every system on the network),” Hutchins <a href="https://twitter.com/MalwareTechBlog/status/1192926822473682944">explained</a>.</p>
      <p>Bluekeep affects Windows 7, Windows Server 2008 R2, and Windows Server 2008. Patches for those versions are available <a href="https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2019-0708">here</a>. Because of its severity, Microsoft has <a href="https://support.microsoft.com/en-us/help/4500705/customer-guidance-for-cve-2019-0708">made patches available</a> for Windows XP, Vista, and Server 2003, which are no longer supported. People or organizations that have yet to patch should do so as soon as possible.</p>
    </article>
  </body>
</html>